# 《MySQL技术内幕：InnoDB存储引擎》

## 第三章 文件

构成MySQL数据库和InnoDB存储引擎表的各种类型的文件

* 参数文件：告诉MySQL实例启动的时候在哪里可以找到数据库文件，并且指定某些初始化参数，这些参数定义了某种内存结构的大小等设置
* 日志文件：错误日志，二进制日志文件，慢查询日志文件，查询日志文件等
* socket文件
* pid文件：MySQL实例的进程ID文件
* MySQL表结构文件：用来存放MySQL表结构定义文件
* 存储引擎文件

### 二进制日志文件

其中二进制日志文件记录了对数据库执行更改的所有操作，不包括select和show这两类操作。

所以用户想要记录select和show这种类型的操作，可以使用查询日志。

除此以外二进制日志文件很重要的一点是可以用来恢复和复制，来达到mysql集群的主从复制的效果。

MySQL5.1开始引入了binlog_format参数，该参数可以设置的值有ROW和STATEMENT和MIXED

STATEMENT：表示二进制日志文件记录的是逻辑SQL语句

ROW：记录的不再是简单的SQL语句，而是记录表的行更改情况。

MIXED：混合模式，默认使用STATEMENT，但是有一些情况下会使用ROW：

* 表的存储引擎为NDB，这时对表的DML操作都会以ROW格式进行记录
* 使用过了UUID(),USER(),FOUND_ROWS(),ROW_COUNT()等不确定函数
* 使用了INSERT DELAY语句
* 使用了用户定义函数
* 使用了临时表

通常情况下，我会将参数设置为ROW，这可以为数据库的恢复和复制带来更好的可靠性，但是不可忽视的一点是，这会带来二进制文件大小的增加。

将参数设置为ROW格式，会对磁盘空间要求有一定的增加。而由于复制是采用传输二进制日志方式实现的，因此复制的网络开销也有所增加。

二进制日志文件的格式是二进制的（废话），所以对二进制文件的查看不可以使用cat，head，tail等命令来查看，必须使用mysql提供的工具mysqlbinlog。对于STATEMENT格式的二进制日志文件，在使用mysqlbinlog查看后，看到的就是执行的逻辑SQL语句。

而如果使用ROW格式的二进制日志文件，mysqlbinlog向我们解释了这条SQL语句所具体做的事情。

如果用户想记录select和show操作，那只能使用查询日志，而不是二进制日志文件。此外，二进制日志还包括了执行数据库更改操作的时间等其他额外信息，总的来说，二进制日志文件有以下几种作用。

* 恢复：某些数据的恢复需要二进制日志，例如，在一个数据库全备文件恢复后，用户可以通过二进制日志进行point-in-time恢复
* 复制：其原理与复制原理类似，通过复制和执行二进制日志使一台远程的mysql数据库与另一台mysql数据库进行实时同步
* 审计：用户可以通过二进制日志中的信息来进行审计，判断是否对数据库进行注入的攻击。

通过配置参数log-bin [=name]可以启动二进制日志，如果不指定name，则默认二进制日志文件名为主机名，后缀名为二进制日志的序列号，所在路径位数据库所在的路径。。

二进制日志在默认情况下是没有开启的，需要手动指定参数来启动，可能会有人质疑，开启这个选项是否会对数据库对整体性能有所影响，根据mysql官方手册中的测试表明，开启二进制日志会使性能下降百分之一，但考虑到可以使用复制和point-in-time的恢复，这些性能的损失是可以忽略不计的。

### 表空间文件

InnoDB采用将存储的数据按照表空间进行存放的设计。在默认配置下会有一个初始大小为10MB，名为ibdata1的文件，该文件就是默认的表空间文件。

用户可以通过多个文件组成一个表空间，同时定制文件的属性。若这两个文件位于不同的磁盘上，磁盘的负载可能被平均，因此可以提高数据库的整体性能。还可以通过参数innodb_file_per_table=ON来产生每个表的单独的表空间文件，需要注意的是，这些单独的表空间文件仅存储该表的数据，索引和插入缓冲bitmap等信息

### 重做日志文件

在默认情况下，在Innodb存储引擎的数据目录下会有两个名为ib_logfile0和ib_logfile1的文件，在mysql官方手册中将其称为Innodb存储引擎的日志文件，但准确的定义应该是重做日志文件，重做日志文件对于innodb存储引擎至关重要，他们记录了对于Innodb存储引擎的事务日志

当实例或介质失败时，重做日志就能派上用场。例如，数据库由于所在主机断电导致实例失败，Innodb存储引擎会使用重做日志恢复到掉电前的时刻，以此来保证数据的完整性。

每个Innodb存储引擎至少有一个重做日志文件组，每个文件组下至少有2个重做日志文件，为了得到更高的可靠性，用户可以设置多个镜像日志组，将不同的文件组放在不同的磁盘上，以此提高重做日志的高可用性。

重做日志文件的大小设置对于Innodb存储引擎的性能有着非常大的影响。一方面，重做日志文件不能设置得太大，如果设置的太大， 在恢复时可能需要很长的时间，另一方面又不能设置的太小，否则可能导致一个事务的日志需要多次切换重做日志文件，此外，重做日志文件太少会导致频繁的发生async checkpoint，导致性能的抖动。

重做日志文件有一个capacity变量，这个变量代表了最后的检查点不能超过这个阈值，如果超过则必须将缓冲池中脏页列表中的部分脏数据写回磁盘，这会导致用户线程的阻塞。

既然同样是记录事务日志，和之前的二进制有什么区别呢？

首先，二进制日志会记录所有与mysql数据库有关的日志记录，包括innodb，myisam，heap等其他存储引擎的日志。而innodb存储引擎的重做日志只记录有关该存储引擎本身的事务日志。

其次，二进制日志文件无论是什么格式，其记录的都是关于一个事务的具体操作内容，即该日志是逻辑日志，而Innodb存储引擎的重做日志文件记录的是关于每个页的更改的物理情况

此外，写入的时间也不同，二进制日志文件仅在事务提交前进行提交，即只写磁盘一次，不论这时该事务有多大，而在事务进行的过程中，却不断的有重做日志条目被写入到重做日志文件中。

在前面也已经提到过，写入重做日志文件的操作不是直接写，而是先写入一个重做日志缓冲中，然后按照一定的条件顺序地写入日志文件。

