# 《MySQL技术内幕：InnoDB存储引擎》

## 第六章 锁

### 前言

开发多用户，数据库驱动的应用时，最大的一个难点是：一方面要最大程度的利用数据库的并发访问，另一方面还要确保每个用户能以一致的方式读取和修改数据，为此就有了锁机制。同时这也是数据库系统区别于文件系统的一个关键特性。锁机制用于管理对共享资源的并发访问，InnoDB存储引擎会在行级别上对表数据上锁。

对于myisam引擎，其锁是表锁设计，并发情况下的读没有问题，但是并发插入时的性能就要差一些了。

InnoDB存储引擎的实现和orcal数据库非常类似，提供一致性的非锁定读，行级锁支持。行级锁没有相关额外的开销，并可以同时得到并发性和一致性。

### lock和latch

latch：模式为：读写锁，互斥量。一般被称为轻量级的锁，因为其要求锁定的时间非常短，若持续的时间长了，应用的性能会变得很差。在InnoDB存储引擎中，latch又分为mutex(互斥量)与rwlock(读写锁)，其目的是用来保证并发线程操作临界资源的正确性，并且通常没有死锁的检测机制。

lock：模式为：行锁，表锁，意向锁。lock的对象是事务，用来锁定的是数据库中的对象，如表，页，行等。并且一般lock的对象仅在事务commit或rollback后进行释放，(不同事务的隔离级别释放的时间可能不同)，lock锁通过waits-for-graph，time-out机制来进行死锁检测和处理。

### InnoDB存储引擎中的锁

锁的类型：InnoDB存储引擎实现了如下两种标准的行级锁：

* 共享锁（S Lock），允许事务读一行数据
* 排他锁（X Lock），允许事务删除或更新一行数据

读锁仅与读锁兼容，写锁与任何锁都不兼容。

此外，InnoDB存储引擎支持多粒度锁定，这种锁定允许事务在行级上的锁与表级上的锁同时存在。为了支持在不同粒度上进行加锁操作，InnoDB存储引擎支持一种额外的锁方式，称为意向锁，意向锁是将锁定的对象分为多个层次，意向锁意味着事务希望在更细粒度上进行加锁。

### 一致性非锁定读

一致性的非锁定读是InnoDB存储引擎通过多版本并发控制的方式来读取当前执行时间数据库中行的数据。如果读取的行正在执行delete或update操作，这时读取操作不会因此去等待行上锁的释放，相反地，InnoDB存储引擎会去读取行的一个快照数据

