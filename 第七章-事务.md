# 《MySQL技术内幕：InnoDB存储引擎》

## 第七章 事务

### 前言

事务是数据库系统区别于文件系统的重要特性之一。

事务会把数据库从一种一致状态转换到另一种一致状态。在数据库提交工作时，可以确保要么所有的修改都已经完成了，要么所有的修改都没有做，并且保存了事务开始前的状态，以便可以回到开始的状态。

InnoDB存储引擎中的事务完全符合ACID四大特性的

* 原子性 atomicity
* 一致性 consistency
* 隔离性 isolation
* 持久性 durability

上一章总结了锁，锁是InnoDB存储引擎实现隔离性的重要保证。本章主要关注事务原子性这一概念。

### 事务概述

事务可由一条SQL语句组成，也可以由多条SQL语句组成。事务是访问并更新数据库中各种数据项的一个程序执行单元。在事务的操作中，要么都做修改，要么都不做，这就是事务的目的。也是事务模型区别于文件系统的重要特征之一。

理论上来说，事务有着极其严格的定义，即通常所说的四大特性。但是值得注意的是，虽然理论上定义了严格的要求，但是各种数据库厂商在开发的时候并没有严格去满足事务的ACID标准，例如对于orcal数据库来说，它的隔离级别是RC，并没有满足隔离性要求，不过在大多数情况下，这并不会导致严重的后果，甚至可能带来性能上的提升。但是作为开发者，我们要知道事务的标准，对于InnoDB存储引擎而言，它的事务是完全严格符合ACID标准的事务。

**A atomicity 原子性**：在计算机系统中，每个人都将原子性视为理所当然。然后在数据库的事务中实现调用操作的原子性，就不是那么理所当然了。

~~~wiki
例如：ATM存取款例子
1.登录ATM平台，验证密码
2.从远程银行的数据库中，取得账户的信息
3.用户在ATM机上输入欲取出的金额
4.从远程银行的数据库中，更新账户信息
5.ATM出款
6.用户取到了钱
~~~

整个过程应该视为原子操作，即要么都做，要么都不做，不能发生用户钱没取到，但是账户余额更新了的情况。原子性是指事务是一个不可分割的执行单元。只有使事务中所有的数据库操作都执行成功，才算整个事务成功。事务中任何一个SQL语句执行失败，已经执行成功的SQL语句都必须撤销，数据库状态应该退回到执行事务前的状态。

如果事务中都是只读的操作，要保持事务的原子性是很简单的，一旦发生任何错误，要么重试，要么返回错误代码。因为只读操作不会影响数据库中的任何部分。如果涉及插入或更新或删除操作，那么就需要保证当发生错误时数据库的状态应该退回事务开始前的状态。

**C consistency 一致性**：一致性是指事务将数据库从一种一致性状态转换到另一种一致性状态。在事务开始前和事务结束后，数据的完整性约束没有被破坏。例如，在一个表中有一个字段为名字，为唯一约束，即在表中姓名不能重复。如果一个事务对姓名字段进行了修改，但是在事务提交或事务操作发生回滚后，表中的姓名变得非唯一了，这就破坏了事务的一致性要求。因此，事务是一致性的单位，如果事务中某个工作失败了，系统可以自动撤销事务---返回初始状态。

**I isolation 隔离性：** 隔离性还有其他称呼，如并发控制，可串行化，锁等。事务的隔离性要求每个读写事务的对象对其他事物的操作对象能相互分离，即该事务提交前对其他事务都是不可见的，通常这使用锁来实现，当前数据库系统都提供了一种粒度锁的策略，不同数据库通过使用的锁的粒度不同来实现不同等级的隔离级别。允许事务仅锁住一个实体对象的子集，以此来提高事务之间的并发度。

**D durability 持久性：** 事务一旦提交，其结果就是永久的，即使发生宕机等故障，数据库也能将事务恢复，需要注意的是，只能从事务本身的角度来保证结果的永久性，例如，在事务提交以后，所有的变化都是永久的。即使数据库因为崩溃而需要恢复时，也能保证恢复后提交的数据都不会丢失，但若不是数据库本身发生故障，而是一些外部原因，如自然灾害等，那么所有提交的数据可能都会丢失，因此持久性保证事务系统的高可靠性，而不是高可用性。对于高可用性的实现，事务本身并不能保证，需要一些系统共同配合来实现。



