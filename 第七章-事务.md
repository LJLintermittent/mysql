# 《MySQL技术内幕：InnoDB存储引擎》

## 第七章 事务

### 前言

事务是数据库系统区别于文件系统的重要特性之一。

事务会把数据库从一种一致状态转换到另一种一致状态。在数据库提交工作时，可以确保要么所有的修改都已经完成了，要么所有的修改都没有做，并且保存了事务开始前的状态，以便可以回到开始的状态。

InnoDB存储引擎中的事务完全符合ACID四大特性的

* 原子性 atomicity
* 一致性 consistency
* 隔离性 isolation
* 持久性 durability

上一章总结了锁，锁是InnoDB存储引擎实现隔离性的重要保证。本章主要关注事务原子性这一概念。

### 事务概述

事务可由一条SQL语句组成，也可以由多条SQL语句组成。事务是访问并更新数据库中各种数据项的一个程序执行单元。在事务的操作中，要么都做修改，要么都不做，这就是事务的目的。也是事务模型区别于文件系统的重要特征之一。

理论上来说，事务有着极其严格的定义，即通常所说的四大特性。但是值得注意的是，虽然理论上定义了严格的要求，但是各种数据库厂商在开发的时候并没有严格去满足事务的ACID标准，例如对于orcal数据库来说，它的隔离级别是RC，并没有满足隔离性要求，不过在大多数情况下，这并不会导致严重的后果，甚至可能带来性能上的提升。但是作为开发者，我们要知道事务的标准，对于InnoDB存储引擎而言，它的事务是完全严格符合ACID标准的事务。

**A atomicity 原子性**：在计算机系统中，每个人都将原子性视为理所当然。然后在数据库的事务中实现调用操作的原子性，就不是那么理所当然了。

~~~wiki
例如：ATM存取款例子
1.登录ATM平台，验证密码
2.从远程银行的数据库中，取得账户的信息
3.用户在ATM机上输入欲取出的金额
4.从远程银行的数据库中，更新账户信息
5.ATM出款
6.用户取到了钱
~~~

整个过程应该视为原子操作，即要么都做，要么都不做，不能发生用户钱没取到，但是账户余额更新了的情况。原子性是指事务是一个不可分割的执行单元。只有使事务中所有的数据库操作都执行成功，才算整个事务成功。事务中任何一个SQL语句执行失败，已经执行成功的SQL语句都必须撤销，数据库状态应该退回到执行事务前的状态。

如果事务中都是只读的操作，要保持事务的原子性是很简单的，一旦发生任何错误，要么重试，要么返回错误代码。因为只读操作不会影响数据库中的任何部分。如果涉及插入或更新或删除操作，那么就需要保证当发生错误时数据库的状态应该退回事务开始前的状态。

**C consistency 一致性**：一致性是指事务将数据库从一种一致性状态转换到另一种一致性状态。在事务开始前和事务结束后，数据的完整性约束没有被破坏。例如，在一个表中有一个字段为名字，为唯一约束，即在表中姓名不能重复。如果一个事务对姓名字段进行了修改，但是在事务提交或事务操作发生回滚后，表中的姓名变得非唯一了，这就破坏了事务的一致性要求。因此，事务是一致性的单位，如果事务中某个工作失败了，系统可以自动撤销事务---返回初始状态。

**I isolation 隔离性：** 隔离性还有其他称呼，如并发控制，可串行化，锁等。事务的隔离性要求每个读写事务的对象对其他事物的操作对象能相互分离，即该事务提交前对其他事务都是不可见的，通常这使用锁来实现，当前数据库系统都提供了一种粒度锁的策略，不同数据库通过使用的锁的粒度不同来实现不同等级的隔离级别。允许事务仅锁住一个实体对象的子集，以此来提高事务之间的并发度。

**D durability 持久性：** 事务一旦提交，其结果就是永久的，即使发生宕机等故障，数据库也能将事务恢复，需要注意的是，只能从事务本身的角度来保证结果的永久性，例如，在事务提交以后，所有的变化都是永久的。即使数据库因为崩溃而需要恢复时，也能保证恢复后提交的数据都不会丢失，但若不是数据库本身发生故障，而是一些外部原因，如自然灾害等，那么所有提交的数据可能都会丢失，因此持久性保证事务系统的高可靠性，而不是高可用性。对于高可用性的实现，事务本身并不能保证，需要一些系统共同配合来实现。

### 事务的分类

从事务理论的角度来说，可以把事务分为以下几种类型：

* 扁平事务
* 带有保存点的扁平事务
* 链事务
* 嵌套事务
* 分布式事务

### 扁平事务

扁平事务是事务类型中最简单的一种，也是使用最多的一种，在扁平事务中，所有操作处于同一层级，其由begin开启，由commit或rollback结束。其间的操作的原子的，要么都执行，要么都回滚。因此扁平事务是应用程序成为原子操作的基本组成模块。

~~~sql
扁平事务的三种情况：
1. begin;
   op1;
   op2;
   op3;
   commit;
2. begin;
   op1;
   op2;
   op3;失败，异常
   rollback；
   应用程序要求停止事务。
3. begin；
   op1；
   op2；
   由于外界原因要回滚，如死锁等。
~~~

扁平事务的主要限制是不能提交或回滚事务的某一部分，或分几个步骤进行提交。也就是说，如果支持有计划的回滚操作，那么不需要终止整个事务，因此就出现了带有保存点的扁平事务。

### 带有保存点的扁平事务

除了支持扁平事务支持的操作外，带有保存点的扁平事务还支持在事务执行的过程中回滚到同一个事务中较早的一个状态。这是因为某些事务可能在执行过程中出现的错误并不会导致所有的操作都无效，放弃整个事务不太合算。保存点用来通知系统应该记住事务当前的状态，以便以后发生错误后可以回到保存点。

### 链事务

链事务可视为保存点模式的一种变种，带有保存点的扁平事务，当发生系统崩溃时，所有的保存点都将消失，因为保存点是易失的，而不是持久的，这意味进行恢复时，事务需要从最开始处重新执行。而不能从最近的一个保存点开始执行。

链事务的思想是：在提交一个事务时，释放不需要的数据对象，将必要的处理上下文隐式地传个下一个要开始的事务。提交事务的操作和开始下一个事务操作将合并为一个原子操作。这意味着下一个事务将能看到上一个事务的结果。就好像在一个事务中发生的一样。

链事务与带有保存点的扁平事务的不同的是，带有保存点的扁平事务能回滚到任意正确的保存点，而链事务的回滚只存在于当前事务。

### 嵌套事务

嵌套事务是一个层次结构，由一个顶层事务控制着各个层次的子事务，最终形成一个类似树状的一种结构。

嵌套事务是由若干事务组成的一棵树，子树既可以是嵌套事务，也可以是扁平事务。

处在叶子节点的事务一定是扁平事务，但是每个子事务从根到叶节点的距离可以是不同的。

子事务的提交不能马上生效，除非其父事务已经提交。所以可以得出一个结论，任何子事务都是在顶层事务提交以后才真正提交。

树中的任意一个事务的回滚的都会引起它的所有子事务的回滚。故子事务仅保留ACI特性，不具有D特性。

### 分布式事务





